export const config = {
  unstable_runtimeJS: false,
};

export default function Home({ headers }) {
  const headerRows = [];
  for (const header in headers) {
    headerRows.push(
      <tr key={header}>
        <td>
          <details>
            <summary className="focus:outline-none">
              <samp className="whitespace-nowrap">{header}</samp>
            </summary>
            <samp className="ml-10">{headers[header]}</samp>
          </details>
        </td>
      </tr>
    );
  }

  return (
    <>
      <h2>What Is This?</h2>
      <p>
        The body of the HTTP response youâ€™re viewing is HTML is generated by a
        Next.js server running on Heroku. The table below lists all the HTTP
        headers that were included in your request.
      </p>
      <table>
        <thead>
          <tr>
            <th>HTTP Header</th>
          </tr>
        </thead>
        <tbody>{headerRows}</tbody>
      </table>
      <p>
        We can confirm traffic is proxied using the Cloudflare dashboard and we
        can see <samp>cf-*</samp> headers in the table above.
        <img
          src="/proxy-through-cloudflare.png"
          width={2048}
          height={406}
          alt="Cloudflare dashboard showing traffic to www.cloudflare.coffee is proxied through Cloudflare"
        />
      </p>
      <h2>Secure Communication Between Cloudflare and the Origin Server</h2>
      <p>
        The communication between Cloudflare and the Origin Server is encrypted.
        The encryption is enabled using the <var>Full</var> encryption mode in
        the Cloudflare dashboard.
        <img
          src="/full-encryption-mode.png"
          width={1922}
          height={1108}
          alt="Cloudflare dashboard showing full encryption"
        />
      </p>
      <h2>Secure Communication Between Your Browser and Cloudflare</h2>
      <p>
        The communication between your broswer and Cloudflare is encrypted. The
        encryption is enabled using two settings in the Cloudflare dashboard:
      </p>
      <ol>
        <li>
          Edge Certificates
          <img
            src="/edge-certificates.png"
            width={1922}
            height={560}
            alt="Cloudflare dashboard showing edge certificates"
          />
        </li>
        <li>
          Always Use HTTPS
          <img
            src="/always-use-https.png"
            width={1922}
            height={368}
            alt="Cloudflare dashboard showing always use HTTPS"
          />
        </li>
      </ol>
      <h2>Cloudflare Worker</h2>
      <p>
        See <a href="/worker">a page served via a Cloudflare worker.</a>
      </p>
      <h2>Secure page</h2>
      <p>
        Access to <a href="/secure">the secure page</a> is restricted to a
        particular user or a group of users.
      </p>
    </>
  );
}

export async function getServerSideProps(context) {
  const sortedHeaders = Object.keys(context.req.headers)
    .sort()
    .reduce((obj, key) => {
      obj[key] = context.req.headers[key];
      return obj;
    }, {});
  return {
    props: {
      headers: { ...sortedHeaders },
    },
  };
}
